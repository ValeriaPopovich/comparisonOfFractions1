<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Сравнение дробей — мини‑игра</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #fff7f5;
      --card: #ffffff;
      --ink: #5b2745; /* тёплый винный */
      --muted: #9b6a7a;
      --accent: #ffb3c1; /* пастель розовый */
      --accent-2: #ffd8be; /* персиковый */
      --accent-3: #c7f2e3; /* мятный */
      --accent-4: #f6f0d7; /* бежевый */
      --good: #38b2ac;
      --bad: #f56565;
      --shadow: 0 10px 30px rgba(91,39,69,.12);
      --radius: 24px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 1200px at 10% 10%, var(--accent-4) 0%, transparent 40%) no-repeat,
                              radial-gradient(900px 900px at 90% 20%, var(--accent-3) 0%, transparent 35%) no-repeat,
                              radial-gradient(700px 700px at 20% 90%, var(--accent-2) 0%, transparent 35%) no-repeat,
                              var(--bg);
      color:var(--ink);
      font-family: "Poppins", "Nunito", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", sans-serif;
      line-height:1.35;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:clamp(12px,2vw,24px)}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:clamp(10px, 2vw, 18px);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:48px; height:48px; border-radius:14px; background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: var(--shadow);
      display:grid; place-items:center; color:#fff; font-weight:800;
    }
    h1{font-size:clamp(22px, 3vw, 34px); margin:0; letter-spacing:0.3px}
    .tg{font-size:clamp(12px,1.8vw,14px); color:var(--muted); opacity:.9}
    .tg b{color:var(--ink)}

    .board{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:clamp(14px, 3vw, 26px);
      display:grid; gap:16px;
    }

    .topbar{display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px}
    .level{
      background:linear-gradient(135deg, var(--accent-3), var(--accent-2));
      padding:8px 14px; border-radius:999px; color:#3b2b2f; font-weight:700; letter-spacing:.3px;
      box-shadow: var(--shadow);
    }
    .lives{display:flex; gap:6px; align-items:center}
    .heart{width:22px; height:22px; filter: drop-shadow(0 4px 8px rgba(0,0,0,.12));}

    .progress{flex:1; height:10px; background:#f3e7ea; border-radius:999px; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(91,39,69,.06)}
    .progress__bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-3)); transition:width .35s ease}

    .arena{display:grid; grid-template-columns:1fr auto 1fr; gap:14px; align-items:stretch}

    .frac{
      background:linear-gradient(180deg,#ffffff, #fff6f9);
      border-radius:20px; padding:18px; box-shadow: var(--shadow);
      display:grid; place-items:center; text-align:center; min-height:150px;
      user-select:none;
    }
    .bigfrac{display:grid; grid-template-rows:1fr auto 1fr; align-items:center; row-gap:8px}
    .num, .den{font-size:clamp(34px, 5vw, 64px); font-weight:800}
    .line{height:4px; width:clamp(80px, 16vw, 180px); background:var(--ink); opacity:.2; border-radius:2px}

    .slot{
      width:clamp(70px, 8vw, 110px); border:2px dashed rgba(91,39,69,.25); border-radius:18px;
      background: rgba(255,255,255,.6); display:grid; place-items:center; font-size:clamp(28px, 4vw, 40px);
      color:var(--muted); transition: all .2s ease; padding: 10px;
    }
    .slot.active{border-color: var(--accent); background:#fff0f5}
    .slot.filled{border-style: solid; background:#fff; color:var(--ink)}

    .tokens{display:flex; gap:12px; justify-content:center; flex-wrap:wrap}
    .token{
      background:#fff; border-radius:16px; padding:10px 16px; font-size:clamp(22px, 3.5vw, 30px); font-weight:800; cursor:grab;
      box-shadow: var(--shadow); border:2px solid transparent; transition: transform .1s, border-color .2s, background .2s;
      user-select:none;
    }
    .token:active{transform:scale(.96); cursor:grabbing}
    .token.selected{border-color: var(--accent); background:#fff5f8}

    .controls{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .btn{
      background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#593243; font-weight:800; border:none; border-radius:14px; padding:12px 18px; cursor:pointer;
      box-shadow: var(--shadow); transition: transform .08s ease;
    }
    .btn:active{transform: translateY(1px)}
    .ghost{background:#efe7ea}

    .hint{
      background:#fff; border-left:6px solid var(--accent); border-radius:14px; padding:12px 14px; box-shadow: var(--shadow);
      font-size:clamp(14px, 2vw, 16px); color:#6c3d50
    }

    .toast{position:fixed; left:50%; top:18px; transform:translateX(-50%); background:#fff; color:var(--ink); padding:12px 16px; border-radius:999px; box-shadow: var(--shadow); z-index:50; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s}
    .toast.show{opacity:1; transform: translate(-50%, 0)}

    .modal{position:fixed; inset:0; display:grid; place-items:center; background:rgba(91,39,69,.28); backdrop-filter:blur(3px); opacity:0; pointer-events:none; transition:opacity .25s}
    .modal.open{opacity:1; pointer-events:auto}
    .dialog{background:#fff; padding:22px; border-radius:22px; box-shadow:var(--shadow); text-align:center; max-width:520px}
    .dialog h2{margin:.2em 0 .3em; font-size:clamp(22px, 3vw, 28px)}
    .dialog p{margin:.25em 0 .6em; color:var(--muted)}

    footer{display:flex; justify-content:center; padding:16px; color:var(--muted); font-size:14px}
    footer a{color:var(--ink); font-weight:800; text-decoration:none; background: linear-gradient(90deg, var(--accent), var(--accent-2)); -webkit-background-clip:text; background-clip:text; color:transparent}

    /* confetti */
    .confetti{position:fixed; inset:0; overflow:hidden; pointer-events:none}
    .paper{position:absolute; width:10px; height:14px; background:var(--accent); border-radius:3px; opacity:0; animation: fall 1.6s ease-out forwards}
    .paper.t2{background:var(--accent-2)}
    .paper.t3{background:var(--accent-3)}
    .paper.t4{background:#f9c0d9}
    @keyframes fall{0%{opacity:1; transform:translate(var(--sx,0), -20px) rotate(0)}100%{opacity:0; transform:translate(var(--ex,0), 80vh) rotate(260deg)}}

    @media (max-width:700px){
      .arena{grid-template-columns:1fr; grid-template-rows:auto auto auto; gap:10px}
      .slot{justify-self:center}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">½</div>
        <div>
          <h1>Сравнение дробей</h1>
          <div class="tg">канал: <b>@lera_easy_math</b></div>
        </div>
      </div>
      <button class="btn" id="howBtn" aria-haspopup="dialog">Как играть</button>
    </header>

    <section class="board" aria-live="polite">
      <div class="topbar">
        <div class="level" id="levelBadge">Уровень 1 · тёплый старт</div>
        <div class="lives" id="lives"></div>
        <div class="progress" aria-label="Прогресс"><div class="progress__bar" id="progressBar"></div></div>
      </div>

      <div class="arena">
        <div class="frac" id="leftCard" aria-label="левая дробь">
          <div class="bigfrac"><div class="num" id="ln"></div><div class="line"></div><div class="den" id="ld"></div></div>
        </div>
        <div class="slot" id="opSlot" aria-dropeffect="move" aria-label="помести знак сравнения сюда">?</div>
        <div class="frac" id="rightCard" aria-label="правая дробь">
          <div class="bigfrac"><div class="num" id="rn"></div><div class="line"></div><div class="den" id="rd"></div></div>
        </div>
      </div>

      <div class="tokens" aria-label="выбери знак">
        <div class="token" draggable="true" data-op="<">&lt;</div>
        <div class="token" draggable="true" data-op=">">&gt;</div>
        <div class="token" draggable="true" data-op="=">=</div>
      </div>

      <div class="controls">
        <button class="btn" id="checkBtn">Проверить</button>
        <div style="display:flex; gap:8px">
          <button class="btn ghost" id="hintBtn">Подсказка</button>
          <button class="btn ghost" id="skipBtn" title="Пропустить задачу">Пропустить</button>
          <button class="btn" id="restartBtn" title="Начать заново">Сброс</button>
        </div>
      </div>

      <div class="hint" id="hintBox" hidden>
        <b>Шпаргалка:</b>
        <ul style="margin:.3em 0 .2em 1.1em; padding:0">
          <li>Одинаковые знаменатели → сравни числители.</li>
          <li>Одинаковые числители → больше та, где знаменатель меньше.</li>
          <li>Иначе: сравни произведения по диагонали: <i>a/b ? c/d</i> → сравни <i>a·d</i> и <i>c·b</i>.</li>
        </ul>
      </div>
    </section>

    <footer>
      Сделано с заботой для математики · <a href="https://t.me/lera_easy_math" target="_blank" rel="noopener">@lera_easy_math</a>
    </footer>
  </div>

  <div class="toast" id="toast">Ты умничка! ✨</div>

  <div class="modal" id="modal">
    <div class="dialog">
      <h2 id="modalTitle">Уровень пройден! 🎉</h2>
      <p id="modalText">Готов к следующему испытанию?</p>
      <button class="btn" id="nextBtn">Дальше</button>
    </div>
  </div>

  <div class="confetti" id="confetti" aria-hidden="true"></div>

  <script>
    // ---------------------- ИГРОВАЯ ЛОГИКА ----------------------
    const opSlot = document.getElementById('opSlot');
    const tokens = Array.from(document.querySelectorAll('.token'));
    const checkBtn = document.getElementById('checkBtn');
    const restartBtn = document.getElementById('restartBtn');
    const skipBtn = document.getElementById('skipBtn');
    const hintBtn = document.getElementById('hintBtn');
    const hintBox = document.getElementById('hintBox');
    const livesBox = document.getElementById('lives');
    const progressBar = document.getElementById('progressBar');
    const levelBadge = document.getElementById('levelBadge');
    const toast = document.getElementById('toast');
    const modal = document.getElementById('modal');
    const nextBtn = document.getElementById('nextBtn');
    const howBtn = document.getElementById('howBtn');

    const ln = document.getElementById('ln');
    const ld = document.getElementById('ld');
    const rn = document.getElementById('rn');
    const rd = document.getElementById('rd');

    const confettiBox = document.getElementById('confetti');

    const LEVELS = [
      { name: 'Уровень 1 · тёплый старт', rounds: 8, rule: 'sameDen' },
      { name: 'Уровень 2 · разношёрстные знаменатели', rounds: 10, rule: 'mix' },
      { name: 'Уровень 3 · близкие дроби', rounds: 10, rule: 'close' }
    ];

    let state = {
      level: 0,
      round: 0,
      lives: 3,
      left: {n: 1, d: 2},
      right: {n: 1, d: 3},
      placed: null, // выбранный знак
      stats: {correct: 0, wrong: 0}
    };

    function rnd(a,b){return Math.floor(Math.random()*(b-a+1))+a}
    function gcd(a,b){return b?gcd(b,a%b):Math.abs(a)}
    function simplify(fr){ const g=gcd(fr.n, fr.d); return {n: fr.n/g, d: fr.d/g} }

    // Генерация дроби с ограничениями
    function genFraction({maxD=12, allowImproper=true}){
      let d = rnd(2, maxD);
      let n = rnd(1, allowImproper ? d*2 : d-1);
      return simplify({n,d});
    }

    function generateTask(){
      const L = LEVELS[state.level];
      let left, right;
      if(L.rule === 'sameDen'){
        const d = rnd(2, 12);
        left = simplify({n: rnd(1, d*2-1), d});
        right = simplify({n: rnd(1, d*2-1), d});
        if(left.n === right.n){ right.n = Math.min(d*2-1, right.n+1) } // избегаем равенства слишком часто
      } else if(L.rule === 'mix'){
        left = genFraction({maxD: 14, allowImproper:true});
        right = genFraction({maxD: 14, allowImproper:true});
        if(left.n/left.d === right.n/right.d){ right.n++ } // реже равенства
      } else { // close — близкие значения, сложнее глазом
        const baseD = rnd(6, 18);
        const a = rnd(1, baseD-1);
        let b = a + (Math.random()<0.5? -1: 1);
        if(b<=0) b=a+1; if(b>=baseD) b=a-1;
        left = simplify({n:a, d:baseD});
        right = simplify({n:b, d:baseD});
        if(Math.random()<0.5){ // иногда делаем разные знаменатели, но близкие по значению
          right = simplify({n: right.n + rnd(-1,1) || right.n, d: baseD + (Math.random()<0.5? -1: 1)});
          if(right.d<2) right.d=2;
        }
      }
      state.left = left; state.right = right; state.placed = null;
      renderTask();
    }

    function renderTask(){
      ln.textContent = state.left.n; ld.textContent = state.left.d;
      rn.textContent = state.right.n; rd.textContent = state.right.d;
      opSlot.textContent = '?';
      opSlot.classList.remove('filled');
      tokens.forEach(t=>t.classList.remove('selected'));
      animateFocus();
    }

    function compare(fr1, fr2){
      const a = fr1.n * fr2.d;
      const b = fr2.n * fr1.d;
      if(a>b) return '>';
      if(a<b) return '<';
      return '=';
    }

    function setPlaced(op){
      state.placed = op;
      opSlot.textContent = op;
      opSlot.classList.add('filled');
      tokens.forEach(t=>t.classList.toggle('selected', t.dataset.op===op));
    }

    // Прогресс и жизни
    function renderLives(){
      livesBox.innerHTML = '';
      for(let i=0;i<3;i++){
        const img = document.createElement('img');
        img.src = i < state.lives
          ? 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f56565"><path d="M12 21s-7.5-4.35-9.6-9.18C1.1 8.52 3.26 5 6.6 5c2.08 0 3.4 1.17 4.1 2.3C11.99 6.17 13.31 5 15.4 5c3.34 0 5.5 3.52 4.2 6.82C19.5 16.65 12 21 12 21z"/></svg>'
          : 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f0bac0"><path d="M12 21s-7.5-4.35-9.6-9.18C1.1 8.52 3.26 5 6.6 5c2.08 0 3.4 1.17 4.1 2.3C11.99 6.17 13.31 5 15.4 5c3.34 0 5.5 3.52 4.2 6.82C19.5 16.65 12 21 12 21z"/></svg>';
        img.className = 'heart';
        img.alt = i < state.lives ? 'жизнь' : 'потерянная жизнь';
        livesBox.appendChild(img);
      }
    }

    function updateProgress(){
      const L = LEVELS[state.level];
      const percent = (state.round / L.rounds) * 100;
      progressBar.style.width = percent + '%';
    }

    function showToast(text){
      toast.textContent = text;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1200);
    }

    function openModal(title, text, nextLabel='Дальше'){
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalText').textContent = text;
      nextBtn.textContent = nextLabel;
      modal.classList.add('open');
    }

    function closeModal(){ modal.classList.remove('open'); }

    function celebrate(){
      // простая конфетти-анимация
      confettiBox.innerHTML = '';
      for(let i=0;i<80;i++){
        const p=document.createElement('div');
        p.className='paper t'+(1+rnd(0,3));
        p.style.left = rnd(0,100)+'vw';
        p.style.setProperty('--sx', rnd(-50,50)+'px');
        p.style.setProperty('--ex', rnd(-60,60)+'px');
        p.style.animationDelay = (i*0.01)+'s';
        confettiBox.appendChild(p);
      }
      setTimeout(()=>confettiBox.innerHTML='', 2000);
    }

    // Анимационный намёк на слот
    function animateFocus(){
      opSlot.classList.add('active');
      setTimeout(()=>opSlot.classList.remove('active'), 600);
    }

    // Проверка ответа
    function check(){
      if(!state.placed){
        showToast('Помести знак в центр 🤏');
        animateFocus();
        return;
      }
      const ans = compare(state.left, state.right);
      if(state.placed === ans){
        state.stats.correct++;
        showToast(['Так держать! ✨','Великолепно! 🌟','Круто! 💫'][rnd(0,2)]);
        // переход к следующему раунду
        state.round++;
        updateProgress();
        if(state.round >= LEVELS[state.level].rounds){
          // уровень пройден
          celebrate();
          if(state.level < LEVELS.length-1){
            openModal('Уровень пройден! 🎉', 'Ты справился с заданиями. Переходим к следующему уровню?');
          } else {
            openModal('Все уровни покорены! 🏆', `Правильных ответов: ${state.stats.correct}. Ошибок: ${state.stats.wrong}.`, 'Сыграть снова');
          }
        } else {
          generateTask();
        }
      } else {
        state.stats.wrong++;
        state.lives--;
        showToast(['Почти! Попробуй ещё 😊','Немного мимо 🙃','Не сдаёмся! 💪'][rnd(0,2)]);
        shake(opSlot);
        if(state.lives<=0){
          openModal('Жизни закончились 😿', 'Ничего, ошибки — это ступеньки к знаниям! Попробуем уровень заново?', 'Ещё раз');
        }
        renderLives();
      }
    }

    function shake(el){
      el.animate([
        { transform:'translateX(0)' },
        { transform:'translateX(-6px)' },
        { transform:'translateX(6px)' },
        { transform:'translateX(-3px)' },
        { transform:'translateX(0)' },
      ], { duration: 220 });
    }

    // Drag & Drop + тапы
    let selectedOp = null;

    tokens.forEach(t=>{
      t.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', t.dataset.op);
        e.dataTransfer.effectAllowed = 'move';
      });
      t.addEventListener('click', ()=>{
        // поведение для тачей — выбрать и тапнуть по слоту
        selectedOp = t.dataset.op;
        tokens.forEach(x=>x.classList.toggle('selected', x===t));
      });
    });

    opSlot.addEventListener('dragover', e=>{ e.preventDefault(); opSlot.classList.add('active') });
    opSlot.addEventListener('dragleave', ()=> opSlot.classList.remove('active'));
    opSlot.addEventListener('drop', e=>{
      e.preventDefault();
      const op = e.dataTransfer.getData('text/plain');
      setPlaced(op);
      opSlot.classList.remove('active');
    });
    opSlot.addEventListener('click', ()=>{
      if(selectedOp){ setPlaced(selectedOp) }
    });

    // Кнопки
    checkBtn.addEventListener('click', check);
    restartBtn.addEventListener('click', ()=>{ startGame(true); });
    skipBtn.addEventListener('click', ()=>{ // пропустить задачу ценой жизни
      if(state.lives>1){ state.lives--; renderLives(); state.round++; updateProgress(); generateTask(); }
      else { showToast('Эх, на пропуск не хватает жизней'); }
    });
    hintBtn.addEventListener('click', ()=>{
      hintBox.hidden = !hintBox.hidden;
    });

    nextBtn.addEventListener('click', ()=>{
      if(state.level < LEVELS.length-1 && state.round >= LEVELS[state.level].rounds){
        state.level++;
        closeModal();
        startLevel();
      } else if(state.lives<=0){
        closeModal();
        startLevel();
      } else { // конец игры
        closeModal();
        startGame(true);
      }
    });

    howBtn.addEventListener('click', ()=>{
      openModal('Как играть', 'Перетащи (или выбери тапом) знак <, > или = в центр между дробями. Нажми «Проверить». Проходи уровни, береги жизни (их 3). Подсказки — под кнопкой «Подсказка». Удачи! 🌈', 'Понятно');
    });

    function startLevel(){
      state.round = 0;
      state.lives = 3;
      renderLives();
      updateProgress();
      levelBadge.textContent = LEVELS[state.level].name;
      generateTask();
    }

    function startGame(resetStats=false){
      if(resetStats){ state.stats = {correct:0, wrong:0}; state.level = 0; }
      startLevel();
    }

    // Запуск
    startGame(true);
  </script>
</body>
</html>
